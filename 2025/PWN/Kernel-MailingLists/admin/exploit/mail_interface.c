
#include <fcntl.h>
#include <stdio.h>

/*
  >> [SOME REQUIRED DEFINITIONS] 
==============================================
*/

#define MAILTMP (0x1 << 0x8)
#define MAILDEL (0x1 << 0x9)
#define MAILBLK (0x1 << 0xa)
#define MAILCLR (0x1 << 0xb)

enum : int {
    INITBOX = 0x1337001,
    SENDMAIL,
    RECVMAIL,
    STAT_SET,
    STAT_GET,
    SUBSCRIBE,
    UNSUBSCRIBE,
    GETPROCINFO,
};

# ifndef NULL
# define NULL 0x0
# endif

# define REGULAR_MAIL    0x1
# define BROADCAST_MAIL  0x2
# define FR_SIZE        0x20

typedef struct usrstat {
    unsigned short ctlop;
    unsigned short nextmtype;
    unsigned public_key;
    unsigned secret_key;
    unsigned nmails;
    unsigned lenmail;
    unsigned lenrmail;
    unsigned nsubs;
    unsigned submax;
} usrstat;

# define ALLMAIL 0x1000
# define REGMAIL 0x2000

typedef struct usrmail {
    unsigned flags;
    unsigned public_key;
    unsigned long secret_key;
    unsigned long size;
    char data [];
} usrmail;

typedef union usr_info {
    usrmail mail;
    usrstat stat;
} usr_info;

# define SYS_IOCTL 0x10


long callsys(long rdi,long rsi,long rdx,void *rcx) {
  long res = 0;
  asm(".intel_syntax noprefix;"
      "mov rax,rdi;"
      "mov rdi,rsi;"
      "mov rsi,rdx;"
      "mov rdx,rcx;"
      "mov r8, r9;"
      "syscall;"
      "mov %0,rax;"
      ".att_syntax"
      :"=r"(res));
      return res;
}

/*
  >> [TEMPLATES AND OTHER INTERFACE FUNCTIONS] 
  ================================================
*/

long extern open_mailbox() {
  return open("/dev/mailbox",O_RDWR);
}

/* ioctl calls */
long do_ioctl ( int fd , int cmd , void *arg) {
    return callsys(SYS_IOCTL,fd,cmd,arg);
}

long extern init_box (int fd,long public_key,long secret_key) {
  usrmail mail;
  mail.public_key = public_key;
  mail.secret_key = secret_key;
  return do_ioctl(fd,INITBOX,&mail);
}

long extern set_box_status (int fd,int status,int maxsubs) {
  usrstat sts;
  sts.submax = maxsubs;
  sts.ctlop = status;
  return do_ioctl(fd,STAT_SET, &sts);
}

long extern get_box_status (int fd,usrstat *stat) {
  return do_ioctl(fd,STAT_GET, stat);
}

long extern sub_mailbox(int fd,long public_key,long secret_key) {
  usrmail mail;
  mail.public_key = public_key;
  mail.secret_key = secret_key;
  return do_ioctl(fd,SUBSCRIBE,&mail);
}

long extern unsub_mailbox(int fd,long public_key,long secret_key) {
  usrmail mail;
  mail.public_key = public_key;
  mail.secret_key = secret_key;
  return do_ioctl(fd,UNSUBSCRIBE,&mail);
}

long extern sendmail(int fd,usrmail *mail) {
  return do_ioctl(fd,SENDMAIL,mail);
}

long extern recvmail(int fd,usrmail *mail) {
  return do_ioctl(fd,RECVMAIL,mail);
}

void showstats(usrstat *stat) {
  printf("[BOX-STATUS] ======================\n");
  char *ctlptr = NULL;
  char *typeptr = NULL;
  switch(stat->ctlop) {
    case MAILTMP:
      ctlptr = "MAILTMP";
      break;
    case MAILBLK:
      ctlptr = "MAILBLK";
      break;
    case MAILCLR:
      ctlptr = "MAILCLR";
      break;
    case MAILDEL:
      ctlptr = "MAILDEL";
      break;
    default:
      ctlptr = "STAT : INVALID ";
      printf("[CTLOPS] = %d\n",stat->ctlop);
  } 

  switch (stat->nextmtype) {
    case REGULAR_MAIL:
      typeptr = "REGULAR";
    case BROADCAST_MAIL:
      typeptr = "BROADCAST";
    default:
      typeptr = "INVALID";
      printf("[TYPE] = %d\n",stat->ctlop);
  }
  
  printf("[CTLOPS] : %s\n",ctlptr);
  printf("[NEXT-MAIL-TYPE] : %s\n",typeptr);
  printf("[NO-OF-MAILS]    : %d\n",stat->nmails);
  printf("[NEXT-MAIL-LEN]  : %d\n",stat->lenmail);
  printf("[NEXT-RMAILLEN]  : %d\n",stat->lenrmail);
  printf("[N-SUBSCRIBERS]  : %d\n",stat->nsubs);
  printf("[NMAX+SUBSCRBR]  : %d\n",stat->submax);
  printf("[PUBLIC-MAIL-K]  : %x\n",stat->public_key);
  printf("[SECRET-MAIL-K]  : %x\n\n",stat->secret_key);

}